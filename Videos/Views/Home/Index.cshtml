@{
    ViewBag.Title = "Home Page";
}

<div id="videoTableOutput">
    test
</div>

@* template for list of videos *@
<script id="videoTable" type="text/html">
    <table>
        <thead>
            <tr>
                <th>Title</th>
                <th>Length</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {{#each video}}
            <tr data-id={{Id}}>
                <td>{{Title}}</td>
                <td>{{Length}}</td>
                <td>
                    <button class="editVideo">Edit</button>
                    <button class="deleteVideo">Delete</button>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</script>

@section scripts {

    <script src="~/Scripts/handlebars.js"></script>
    <script src="~/Scripts/_references.js"></script>

    <script>

        // define module to encapsulate video server
        var videoServer = (function () {

            // api url determined from route config
            var videoApiUrl = '@Url.HttpRouteUrl("DefaultApi", new { httproute = "", Controller = "videos" })';

            // handler for any ajax error
            $(document).ajaxError(function (event, xhr) { alert(xhr.status + ":" + xhr.statusText); });

            // expose promise for getting videos from api
            var getVideos = function () { return $.ajax(videoApiUrl); }

            return {
                getVideos: getVideos
            };

        })();
        
        // self-invoking function:
        // compile moustache template, call server to get video collection and pass to moustache to render
        (function () {

            var templates = {};

            var compileTemplates = function () {
                templates.videoTable = Handlebars.compile($('#videoTable').html());
            };

            var showAllVideos = function (data) {
                var output = templates.videoTable({ video: data });
                $('#videoTableOutput').html(output);
            };

            var refreshVideos = function () {
                videoServer.getVideos().done(showAllVideos);
            };

            // on dom ready...
            $(function () {
                compileTemplates();
                refreshVideos();
            });

        })();

    </script>
}